Name:       freshmaker
Version:    $FRESHMAKER_VERSION
Release:    $FRESHMAKER_RELEASE%{?dist}
Summary:    Freshmaker is a service scheduling rebuilds of artifacts as new content becomes available.

Group:      Development/Tools
License:    MIT
URL:        https://pagure.io/freshmaker
Source0:    https://files.pythonhosted.org/packages/source/o/%{name}/%{name}-%{version}.tar.gz

BuildArch:    noarch

BuildRequires:    python3-fedmsg
BuildRequires:    help2man
BuildRequires:    python3-kobo
BuildRequires:    python3-kobo-rpmlib
BuildRequires:    python3-devel
BuildRequires:    python3-flask-migrate
BuildRequires:    python3-pdc-client
BuildRequires:    python3-flask-script
BuildRequires:    python3-httplib2
BuildRequires:    python3-munch
BuildRequires:    python3-odcs-client
BuildRequires:    python3-dogpile-cache
BuildRequires:    python3-krbcontext
BuildRequires:    python3-flask-login
BuildRequires:    python3-ldap
BuildRequires:    python3-pyyaml
BuildRequires:    git
BuildRequires:    python3-qpid-proton
BuildRequires:    python3-tabulate
BuildRequires:    python3-kerberos

BuildRequires:    python3-setuptools
BuildRequires:    python3-fedora
BuildRequires:    python3-flask
BuildRequires:    python3-flask-sqlalchemy
BuildRequires:    python3-mock
BuildRequires:    python3-psutil
BuildRequires:    python3-pytest
BuildRequires:    python3-pyOpenSSL
BuildRequires:    python3-sqlalchemy
BuildRequires:    python3-koji
BuildRequires:    python3-psycopg2
BuildRequires:    python3-defusedxml
BuildRequires:    python3-prometheus_client

BuildRequires:    systemd
%{?systemd_requires}

Requires:    python3-fedmsg
Requires:    systemd
Requires:    python3-kobo
Requires:    python3-kobo-rpmlib
Requires:    python3-openidc-client
Requires:    python3-pdc-client
Requires:    python3-flask-script
Requires:    python3-httplib2
Requires:    python3-munch
Requires:    python3-odcs-client
Requires:    python3-dogpile-cache
Requires:    python3-krbcontext
Requires:    python3-flask-login
Requires:    python3-ldap
Requires:    python3-pyyaml
Requires:    git
Requires:    python3-qpid-proton
Requires:    python3-tabulate

Requires:    python3-koji
Requires:    python3-fedora
Requires:    python3-flask
Requires:    python3-flask-migrate
Requires:    python3-flask-sqlalchemy
Requires:    python3-mock
Requires:    python3-psutil
Requires:    python3-pyOpenSSL
Requires:    python3-sqlalchemy
Requires:    python3-systemd
Requires:    python3-psycopg2
Requires:    python3-defusedxml
Requires:    python3-prometheus_client
Requires:    python3-kerberos


%description
Freshmaker is a service scheduling rebuilds of artifacts as new content becomes available.


%prep
%setup -q

sed -i '/ldap/d' requirements.txt
sed -i '/koji/d' requirements.txt


%build
%py3_build


%install
%py3_install

export PYTHONPATH=%{buildroot}%{python3_sitelib}
mkdir -p %{buildroot}%{_mandir}/man1
for command in freshmaker-manager freshmaker-frontend freshmaker-gencert freshmaker-upgradedb ; do
FRESHMAKER_CONFIG_FILE=conf/config.py %{buildroot}%{_bindir}/$command --help || true
FRESHMAKER_CONFIG_FILE=conf/config.py help2man -N --version-string=%{version} \
    %{buildroot}%{_bindir}/$command > \
    %{buildroot}%{_mandir}/man1/$command.1
done

install -d -m 0755 %{buildroot}%{_datadir}/freshmaker
install -p -m 0644 contrib/freshmaker.wsgi %{buildroot}%{_datadir}/freshmaker


%files
%doc README.md
%license LICENSE
%{python3_sitelib}/freshmaker*
%{_bindir}/freshmaker-*
%{_mandir}/man1/freshmaker-*.1*
%dir %{_sysconfdir}/freshmaker
%{_datadir}/freshmaker
%{_sysconfdir}/fedmsg.d/*
%config(noreplace) %{_sysconfdir}/freshmaker/config.py
%exclude %{_sysconfdir}/freshmaker/*.py[co]
%exclude %{_sysconfdir}/fedmsg.d/*.py[co]
%exclude %{python3_sitelib}/conf/


%changelog
